<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Match - LocalCricbuzz</title>
    <link rel="stylesheet" href="../css/cricbuzz-style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                üèè LocalCricbuzz - Live Scoring
            </div>
            <div class="user-actions">
                <button onclick="window.location.href='dashboard.html'" class="btn btn-secondary">‚Üê Dashboard</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Match Info -->
        <div class="score-display" id="matchInfo">
            <div id="matchTitle" style="font-size: 1.2rem; margin-bottom: 1rem;"></div>
            <div class="current-score" id="currentScore">0/0 (0.0)</div>
            <div id="currentStatus" style="font-size: 1rem; opacity: 0.9;"></div>
        </div>

        <!-- Scoring Panel -->
        <div class="score-panel">
            <h3 style="margin-bottom: 1rem;">‚ö° Score Update</h3>
            
            <div class="score-buttons">
                <button class="score-btn" onclick="updateScore(0)">0</button>
                <button class="score-btn" onclick="updateScore(1)">1</button>
                <button class="score-btn" onclick="updateScore(2)">2</button>
                <button class="score-btn" onclick="updateScore(3)">3</button>
                <button class="score-btn" onclick="updateScore(4)">4</button>
                <button class="score-btn" onclick="updateScore(5)">5</button>
                <button class="score-btn" onclick="updateScore(6)">6</button>
                <button class="score-btn wicket" onclick="updateWicket()">OUT</button>
                <button class="score-btn" onclick="updateExtra('wd')">WD</button>
                <button class="score-btn" onclick="updateExtra('nb')">NB</button>
                <button class="score-btn" onclick="updateExtra('bye')">BYE</button>
                <button class="score-btn" onclick="updateExtra('lb')">LB</button>
            </div>

            <div style="margin-top: 2rem;">
                <button onclick="endInnings()" class="btn btn-secondary" style="width: 100%;">
                    End Innings
                </button>
            </div>
        </div>

        <!-- Commentary -->
        <div class="live-section">
            <h3>üìù Commentary</h3>
            <div id="commentary" style="max-height: 400px; overflow-y: auto;">
                <div class="loading">Commentary will appear here...</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../js/config.js"></script>
    <script>
        // Check Login
        const userMobile = localStorage.getItem('userMobile');
        if (!userMobile) {
            alert('Please login first!');
            window.location.href = 'login.html';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const matchId = urlParams.get('id');
        let matchData = null;

        if (!matchId) {
            alert('Invalid match!');
            window.location.href = 'dashboard.html';
        }

        // Load Match Data
        db.ref('matches/' + matchId).on('value', (snapshot) => {
            matchData = snapshot.val();
            if (matchData) {
                updateDisplay();
            }
        });

        function updateDisplay() {
            const currentTeamKey = matchData.currentInnings === 1 ? 'team1' : 'team2';
            const currentTeam = matchData[currentTeamKey];
            
            document.getElementById('matchTitle').textContent = 
                `${matchData.team1.name} vs ${matchData.team2.name}`;
            
            document.getElementById('currentScore').textContent = 
                `${currentTeam.runs}/${currentTeam.wickets} (${(currentTeam.balls / 6).toFixed(1)})`;
            
            document.getElementById('currentStatus').textContent = 
                `Innings ${matchData.currentInnings} - ${matchData.currentBatter} batting`;

            // Update Commentary
            if (matchData.commentary && matchData.commentary.length > 0) {
                const commentaryHtml = matchData.commentary.slice(-10).reverse().map(c => `
                    <div style="background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px; border-left: 3px solid var(--primary-green);">
                        <strong>${c.over}</strong> - ${c.text}
                    </div>
                `).join('');
                document.getElementById('commentary').innerHTML = commentaryHtml;
            }
        }

        function updateScore(runs) {
            if (!matchData) return;

            const currentTeamKey = matchData.currentInnings === 1 ? 'team1' : 'team2';
            const currentTeam = matchData[currentTeamKey];

            currentTeam.runs += runs;
            currentTeam.balls++;
            currentTeam.overs = (currentTeam.balls / 6).toFixed(1);
            currentTeam.score = `${currentTeam.runs}/${currentTeam.wickets}`;

            // Add Commentary
            let commentaryText = runs === 0 ? 'Dot ball' :
                                runs === 4 ? 'üéØ FOUR!' :
                                runs === 6 ? 'üî• SIX!' :
                                `${runs} run${runs > 1 ? 's' : ''}`;

            addCommentary(currentTeam.overs, commentaryText);

            // Check over complete
            if (currentTeam.balls % 6 === 0) {
                addCommentary(currentTeam.overs, `--- End of Over ${Math.floor(currentTeam.balls / 6)} ---`);
            }

            db.ref('matches/' + matchId).update(matchData);
        }

        function updateWicket() {
            if (!matchData) return;

            const currentTeamKey = matchData.currentInnings === 1 ? 'team1' : 'team2';
            const currentTeam = matchData[currentTeamKey];

            currentTeam.wickets++;
            currentTeam.balls++;
            currentTeam.overs = (currentTeam.balls / 6).toFixed(1);
            currentTeam.score = `${currentTeam.runs}/${currentTeam.wickets}`;

            addCommentary(currentTeam.overs, 'üö® WICKET! Batsman OUT!');

            if (currentTeam.wickets >= 10) {
                alert('All Out!');
                endInnings();
                return;
            }

            db.ref('matches/' + matchId).update(matchData);
        }

        function updateExtra(type) {
            if (!matchData) return;

            const currentTeamKey = matchData.currentInnings === 1 ? 'team1' : 'team2';
            const currentTeam = matchData[currentTeamKey];

            currentTeam.runs++; // Extra run
            
            let commentaryText = '';
            if (type === 'wd') {
                commentaryText = 'Wide Ball!';
            } else if (type === 'nb') {
                commentaryText = 'No Ball!';
                currentTeam.balls++; // No ball counts as ball
            } else if (type === 'bye') {
                commentaryText = 'Bye!';
                currentTeam.balls++;
            } else if (type === 'lb') {
                commentaryText = 'Leg Bye!';
                currentTeam.balls++;
            }

            currentTeam.overs = (currentTeam.balls / 6).toFixed(1);
            currentTeam.score = `${currentTeam.runs}/${currentTeam.wickets}`;

            addCommentary(currentTeam.overs, commentaryText);

            db.ref('matches/' + matchId).update(matchData);
        }

        function addCommentary(over, text) {
            if (!matchData.commentary) matchData.commentary = [];
            matchData.commentary.push({
                over: over,
                text: text,
                timestamp: Date.now()
            });
        }

        function endInnings() {
            if (!confirm('End Innings ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§Ç?')) return;

            if (matchData.currentInnings === 1) {
                matchData.currentInnings = 2;
                matchData.currentBatter = matchData.battingSecond;
                matchData.currentInfo = `${matchData.battingSecond} needs ${matchData.team1.runs + 1} runs to win`;
                
                addCommentary('-', '--- End of Innings 1 ---');
                alert('Innings 1 ‡§∏‡§Ç‡§™‡§≤‡§Ç! Innings 2 ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ.');
            } else {
                matchData.status = 'completed';
                
                const team1Runs = matchData.team1.runs;
                const team2Runs = matchData.team2.runs;
                
                if (team1Runs > team2Runs) {
                    matchData.currentInfo = `${matchData.team1.name} won by ${team1Runs - team2Runs} runs!`;
                } else if (team2Runs > team1Runs) {
                    matchData.currentInfo = `${matchData.team2.name} won by ${10 - matchData.team2.wickets} wickets!`;
                } else {
                    matchData.currentInfo = 'Match Tied!';
                }

                alert('Match Complete! ' + matchData.currentInfo);
            }

            db.ref('matches/' + matchId).update(matchData);
        }
    </script>
</body>
</html>
